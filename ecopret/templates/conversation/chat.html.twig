{% extends 'base.html.twig' %}

{% block title %}Chat{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/chat.css') }}">
{% endblock %}

{% block javascripts %}
    <script>
        window.onload = function () {
            let chatDiv = document.getElementById('chat');
            let timeout = setTimeout(deconnection, 600 * 1000);
            window.scrollTo(0, document.body.scrollHeight);

            let form = document.getElementById('form');
            function handleForm(event) {
                event.preventDefault();
            }
            form.addEventListener('submit', handleForm);

            const submit = document.querySelector('button');
            submit.onclick = e => {
                let message = document.getElementById('message').value;
                if(message !== "") {
                    const data = {
                        'content': message,
                        'conv': {{ conv.id }}
                    }
                    fetch('/message/post', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    }).then((response) => {
			document.getElementById('message').value = '';	
                    });

                    chatDiv.innerHTML += ("<div class=\"message-right\"><div class=\"bulle-droite\"><b>Vous</b><p>{message}</p></div></div>").replace("{message}", message);
                    window.scrollTo(0, document.body.scrollHeight);
                }
                clearTimeout(timeout);
                timeout = setTimeout(deconnection, 600 * 1000);
            }

           setInterval(recupererMessages, 2000, {{ conv.id }});
        }

        async function recupererMessages(id){
            fetch('/message/get', {
                method: 'POST',
                body: id
            }).then((response) => {
                appendMessages(response)
            });

            let chatDiv = document.getElementById('chat');
            chatDiv.scrotop = chatDiv.scrollHeight;
        }

        async function appendMessages(response){
            let chatDiv = document.getElementById('chat');
            let messages = JSON.parse(await response.text());
            messages.forEach(message => {
                if (message.expeditaire === {{ app.user.id }}){
                    chatDiv.innerHTML += ("<div class=\"message-right\"><div class=\"bulle-droite\"><b>Vous</b><p>{message}</p></div></div>".replace("{message}", message.message));
                }
                else {
                    chatDiv.innerHTML += ("<div class=\"message-left\"><div class=\"bulle-gauche\"><b>{prenom}</b><p>{message}</p></div></div>".replace("{prenom}", message.prenom).replace("{message}", message.message));
                }
                window.scrollTo(0, document.body.scrollHeight);
            });
        }

        function deconnection(){
            location.href ="/conversation";
        }
    </script>
{% endblock %}
{% block body %}
    <div class="container">
        <div id="chat">
            {% for message in messages %}
                {% if app.user == message.expeditaire %}
                    <div class="message-right">
                        <div class="bulle-droite">
                            <b>Vous</b>
                            <p>{{ message.message }}</p>
                        </div>
                    </div>
                {% else %}
                    <div class="message-left">
                        <div class="bulle-gauche">
                            <b>{{ message.expeditaire.PrenomCompte }}</b>
                            <p>{{ message.message }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
            <form id="form">
                <input id="message" class="div_input" placeholder="Message" type="text" autocomplete="off"/>
                <button id="submit" type="submit" class="message_btn">Envoyer</button>
            </form>
    </div>
{% endblock %}
